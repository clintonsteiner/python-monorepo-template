name: Publish

on:
  push:
    tags:
      - "v*"
      - "my-library-v*"
      - "my-app-v*"
      - "my-cli-v*"

jobs:
  determine-packages:
    runs-on: ubuntu-latest
    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
        with:
          fetch-depth: 0

      - name: Determine which packages to publish
        id: set-matrix
        run: |
          TAG=${{ github.ref_name }}
          MATRIX='["my-library", "my-app", "my-cli"]'

          if [[ $TAG == my-library-v* ]]; then
            MATRIX='["my-library"]'
          elif [[ $TAG == my-app-v* ]]; then
            MATRIX='["my-app"]'
          elif [[ $TAG == my-cli-v* ]]; then
            MATRIX='["my-cli"]'
          fi

          echo "matrix=$(echo $MATRIX | jq -c .)" >> $GITHUB_OUTPUT

  publish:
    needs: determine-packages
    runs-on: ubuntu-latest
    strategy:
      matrix:
        package: ${{ fromJson(needs.determine-packages.outputs.matrix) }}
    permissions:
      contents: read
      id-token: write
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2

      - name: Install uv
        uses: astral-sh/setup-uv@eac588ad8def6316056a12d4907a9d4d84ff7a3b # v7.3.0
        with:
          version: "latest"

      - name: Set up Python
        uses: actions/setup-python@a309ff8b426b58ec0e2a45f0f869d46889d02405 # v6.2.0
        with:
          python-version-file: pyproject.toml

      - name: Sync dependencies
        run: uv sync

      - name: Build ${{ matrix.package }}
        run: uv build packages/${{ matrix.package }}

      - name: Publish ${{ matrix.package }} to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1
        with:
          packages-dir: packages/${{ matrix.package }}/dist
